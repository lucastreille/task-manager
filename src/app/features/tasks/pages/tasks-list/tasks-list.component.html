<div class="page">
  <div class="page__header">
    <div>
      <h1 class="page__title">Mes tâches</h1>
      <p class="page__subtitle">Board collaboratif (API connectée)</p>
    </div>
    <a class="btn btn--primary" routerLink="/tasks/new">+ Nouvelle tâche</a>
  </div>

  <div class="filter-bar">
    <span class="filter-bar__label">Filtrer :</span>
    <div class="filter-bar__buttons">
      <button
        type="button"
        class="filter-btn"
        [class.filter-btn--active]="activeFilter() === 'ALL'"
        (click)="setFilter('ALL')">
        Toutes
      </button>
      <button
        type="button"
        class="filter-btn"
        [class.filter-btn--active]="activeFilter() === 'PENDING'"
        (click)="setFilter('PENDING')">
        À faire
      </button>
      <button
        type="button"
        class="filter-btn"
        [class.filter-btn--active]="activeFilter() === 'DONE'"
        (click)="setFilter('DONE')">
        Terminées
      </button>
    </div>
  </div>

  @if (error()) {
    <div class="alert">{{ error() }}</div>
  }

  @if (loading()) {
    <div class="skeleton">Chargement…</div>
  }

  @if (!loading()) {
    <div class="board">
      <section class="col">
        <header class="col__header">
          <div class="col__title">
            <span class="dot dot--todo"></span>
            <span>À faire</span>
          </div>
          <span class="count">{{ pendingTasks().length }}</span>
        </header>

        <div class="col__body">
          @if (pendingTasks().length === 0) {
            <div class="empty">Aucune tâche.</div>
          }

          @for (task of pendingTasks(); track trackById($index, task)) {
            <article class="card">
              <div class="card__top">
                <a class="card__title" [routerLink]="['/tasks', task.id]">
                  {{ task.title }}
                </a>
                <span [class]="badgeClass('PENDING')">PENDING</span>
              </div>

              @if (task.description) {
                <p class="card__desc">{{ task.description }}</p>
              }

              <div class="meta">
                <span class="meta__line">Assigné à : <strong>{{ task.user.username }}</strong></span>
                <span class="meta__line">
                  Créée : {{ task.createdAt | date:'dd/MM/yyyy HH:mm' }}
                  <span class="sep"><br/></span>
                  Modifiée : {{ task.updatedAt | date:'dd/MM/yyyy HH:mm' }}
                </span>
              </div>

              <div class="actions">
                <a class="link" [routerLink]="['/tasks', task.id]">Voir</a>
                <a class="link" [routerLink]="['/tasks', task.id, 'edit']">Modifier</a>
                <button class="link link--danger" type="button" (click)="delete(task.id)">Supprimer</button>
              </div>
            </article>
          }
        </div>
      </section>

      <section class="col">
        <header class="col__header">
          <div class="col__title">
            <span class="dot dot--progress"></span>
            <span>En cours</span>
          </div>
          <span class="count">{{ inProgressTasks().length }}</span>
        </header>

        <div class="col__body">
          @if (inProgressTasks().length === 0) {
            <div class="empty">Aucune tâche.</div>
          }

          @for (task of inProgressTasks(); track trackById($index, task)) {
            <article class="card">
              <div class="card__top">
                <a class="card__title" [routerLink]="['/tasks', task.id]">
                  {{ task.title }}
                </a>
                <span [class]="badgeClass('IN_PROGRESS')">IN_PROGRESS</span>
              </div>

              @if (task.description) {
                <p class="card__desc">{{ task.description }}</p>
              }

              <div class="meta">
                <span class="meta__line">Assigné à : <strong>{{ task.user.username }}</strong></span>
                <span class="meta__line">
                  Créée : {{ task.createdAt | date:'dd/MM/yyyy HH:mm' }}
                  <span class="sep"><br/></span>
                  Modifiée : {{ task.updatedAt | date:'dd/MM/yyyy HH:mm' }}
                </span>
              </div>

              <div class="actions">
                <a class="link" [routerLink]="['/tasks', task.id]">Voir</a>
                <a class="link" [routerLink]="['/tasks', task.id, 'edit']">Modifier</a>
                <button class="link link--danger" type="button" (click)="delete(task.id)">Supprimer</button>
              </div>
            </article>
          }
        </div>
      </section>

      <section class="col">
        <header class="col__header">
          <div class="col__title">
            <span class="dot dot--done"></span>
            <span>Terminé</span>
          </div>
          <span class="count">{{ doneTasks().length }}</span>
        </header>

        <div class="col__body">
          @if (doneTasks().length === 0) {
            <div class="empty">Aucune tâche.</div>
          }

          @for (task of doneTasks(); track trackById($index, task)) {
            <article class="card">
              <div class="card__top">
                <a class="card__title card__title--done" [routerLink]="['/tasks', task.id]">
                  {{ task.title }}
                </a>
                <span [class]="badgeClass('DONE')">DONE</span>
              </div>

              @if (task.description) {
                <p class="card__desc">{{ task.description }}</p>
              }

              <div class="meta">
                <span class="meta__line">Assigné à : <strong>{{ task.user.username }}</strong></span>
                <span class="meta__line">
                  Créée : {{ task.createdAt | date:'dd/MM/yyyy HH:mm' }}
                  <span class="sep"><br/></span>
                  Modifiée : {{ task.updatedAt | date:'dd/MM/yyyy HH:mm' }}
                </span>
              </div>

              <div class="actions">
                <a class="link" [routerLink]="['/tasks', task.id]">Voir</a>
                <a class="link" [routerLink]="['/tasks', task.id, 'edit']">Modifier</a>
                <button class="link link--danger" type="button" (click)="delete(task.id)">Supprimer</button>
              </div>
            </article>
          }
        </div>
      </section>
    </div>
  }
</div>
